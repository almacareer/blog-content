name: CI
on:
  push:
    branches:
      - '*'


jobs:
  build:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        branch: [main, master, dev, feature/*]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{ matrix.branch }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-1
        
    - name: Login to ECR
      run: aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 035814641800.dkr.ecr.eu-west-1.amazonaws.com
    
    - name: Build and push the container images
      run: |
        for file in $(find . -name "Dockerfile*"); do
          image_name=${{ github.event.repository.name }} # previous version: $(echo $file | awk -F '/' '{print $2}')
          tag_name=${{ matrix.branch }}-${{ github.sha }}
          echo "Building image $image_name:$tag_name"
          docker build -t 035814641800.dkr.ecr.eu-west-1.amazonaws.com/$image_name:$tag_name -f $file .
          echo "Pushing image $image_name:$tag_name"
          docker push 035814641800.dkr.ecr.eu-west-1.amazonaws.com/$image_name:$tag_name
        done
